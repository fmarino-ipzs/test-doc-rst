name: Manual PR Preview

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number to build preview for'
        required: true

env:
  DEFAULT_BRANCH: versione-corrente

jobs:
  build-pr-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.inputs.pr_number }}/head
          
      # Install Python 
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          architecture: "x64"

      # Install Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install Graphviz required for plantuml
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      # Install python dependencies 
      - name: Install deps
        run: |-
          python -m pip install -r requirements-dev.txt

      - name: Set deployment path
        id: deployment
        run: |
          echo "path=prs/pr${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT

      # Run Sphinx build for HTML output
      - name: Build branch
        run: |-
          # Create output directories
          mkdir -p "html/${{ steps.deployment.outputs.path }}/it"
          mkdir -p "html/${{ steps.deployment.outputs.path }}/en"

          echo "Building html/${{ steps.deployment.outputs.path }}/it"
          echo "Building html/${{ steps.deployment.outputs.path }}/en"

          sphinx-build -b html docs/it/ html/${{ steps.deployment.outputs.path }}/it
          sphinx-build -b html docs/en/ html/${{ steps.deployment.outputs.path }}/en

      - name: Copy python scripts for deploy
        run: |
          mkdir -p html/scripts/ && cp -r .github/scripts/* html/scripts/
          mkdir -p html/templates/ && cp -r .github/templates/* html/templates/
          mkdir -p html/static/ && cp -r .github/static/* html/static/

      - name: Deploy to GitHub Pages
        if: success()
        uses: crazy-max/ghaction-github-pages@v2
        with:
          target_branch: gh-pages
          build_dir: html
          keep_history: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.inputs.pr_number }};
            const repoUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
            const previewUrl = `${repoUrl}/prs/pr${prNumber}/`;
            
            const comment = `âœ… Preview for this PR has been manually generated and is available here: ${previewUrl}`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  generate-index:
      needs: build-pr-preview  # This ensures this job runs only after build and deploy jobs are succesfully completed
      runs-on: ubuntu-latest
      steps:
        # Check out the gh-pages branch
        - name: Checkout gh-pages branch
          uses: actions/checkout@v3
          with:
            ref: gh-pages  # Checkout the gh-pages branch
                
        # Install Python
        - uses: actions/setup-python@v4
          with:
            python-version: "3.10"
            
        # Install python dependancies 
        - name: Install deps
          run: |-
            python -m pip install Jinja2==3.1.6

        # Run the Python script
        - name: Run the Python script for cleanup and index generation
          env:
            GH_TOKEN: ${{ github.token }}
          run: |
            # Run the Python scripts 
            python ./scripts/cleanup_old_prs.py
            python ./scripts/generate_index.py
            
            
        # Commit and push back to gh-pages
        - name: Commit and push 
          run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git add .
            git commit -m "Auto-generate index.html" || echo "No changes to commit"
            git push