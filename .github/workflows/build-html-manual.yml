name: Manual PR Preview

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number to build preview for'
        required: true
      branch_name:
        description: 'Branch name to checkout'
        required: true

env:
  DEFAULT_BRANCH: versione-corrente

jobs:
  build-pr-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          
      # Install Python 
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          architecture: "x64"

      # Install Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install Graphviz required for plantuml
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      # Install python dependencies 
      - name: Install deps
        run: |-
          python -m pip install -r requirements-dev.txt

      - name: Set deployment path
        id: deployment
        run: |
          echo "path=prs/pr${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT

      # Run Sphinx build for HTML output
      - name: Build branch
        run: |-
          # Create output directories
          mkdir -p "html/${{ steps.deployment.outputs.path }}/it"
          mkdir -p "html/${{ steps.deployment.outputs.path }}/en"

          echo "Building html/${{ steps.deployment.outputs.path }}/it"
          echo "Building html/${{ steps.deployment.outputs.path }}/en"

          sphinx-build -b html docs/it/ html/${{ steps.deployment.outputs.path }}/it
          sphinx-build -b html docs/en/ html/${{ steps.deployment.outputs.path }}/en

      - name: Copy python scripts for deploy
        run: |
          cp .github/scripts/generate_index.py html/generate_index.py
          cp .github/scripts/cleanup_old_prs.py html/cleanup_old_prs.py

      - name: Deploy to GitHub Pages
        if: success()
        uses: crazy-max/ghaction-github-pages@v2
        with:
          target_branch: gh-pages
          build_dir: html
          keep_history: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.inputs.pr_number }};
            const comment = `âœ… Preview for this PR has been manually generated and is available here: https://[your-github-pages-url]/prs/pr${prNumber}/`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });